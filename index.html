<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Glass Player â€” å®Œæ•´ç‰ˆï¼ˆå«æ¸¬è©¦æ›²ï¼‰</title>
  <style>
    :root{
      --bg:#07060b; --card:rgba(255,255,255,0.04); --glass-border:rgba(255,255,255,0.06);
      --accent1:#7C5CFF; --accent2:#00E5A8; --muted:rgba(255,255,255,0.65);
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0;background:
      radial-gradient(800px 400px at 10% 10%, rgba(124,92,255,0.05), transparent 6%),
      linear-gradient(180deg,var(--bg),#050509); color:#eaf0ff; font-family:Inter, "Microsoft JhengHei", system-ui}
    /* layout */
    .wrap{display:flex;height:100vh;gap:20px;padding:22px}
    .panel{background:var(--card);border-radius:14px;border:1px solid var(--glass-border);
      padding:16px;box-shadow:0 10px 40px rgba(2,6,23,0.6);backdrop-filter:blur(8px) saturate(120%)}
    /* left playlist */
    #left{width:22%;display:flex;flex-direction:column;gap:12px;overflow:hidden}
    #left .panel{flex:1;overflow:auto;padding:14px}
    .track{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;
      border-radius:10px;margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid rgba(255,255,255,0.02);transition:transform .12s,box-shadow .12s}
    .track:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(3,6,18,0.6)}
    .meta{flex:1;padding-right:12px;font-size:14px;color:#e6f0ff}
    .dur{font-size:12px;color:var(--muted)}
    .small-btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041018;box-shadow:0 8px 24px rgba(2,6,23,0.5)}
    /* center */
    #center{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px}
    #title{font-size:20px;font-weight:800;color:var(--accent2);text-shadow:0 6px 28px rgba(0,229,168,0.06)}
    #time{color:var(--muted);font-size:14px}
    /* right controls */
    #right{width:22%;display:flex;flex-direction:column;gap:12px}
    #right .panel{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center}
    .big-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:none;cursor:pointer;
      font-weight:800;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041018;box-shadow:0 12px 30px rgba(2,6,23,0.5);position:relative;overflow:hidden}
    .big-btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none}
    .big-btn::before{content:"";position:absolute;left:-120%;top:0;height:100%;width:40%;background:linear-gradient(120deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14), rgba(255,255,255,0.06));transform:skewX(-20deg);transition:left .6s}
    .big-btn:hover::before{left:160%}
    label.file-btn{cursor:pointer;padding:10px 16px;border-radius:999px;background:linear-gradient(90deg,#2b2b36,#1a1a1f);border:1px solid rgba(255,255,255,0.04);color:var(--muted);display:inline-block;font-weight:700}
    input[type=file]{display:none}
    .row{width:100%;display:flex;flex-direction:column;gap:6px;align-items:stretch}
    .slider{width:100%}
    .mode-indicator{font-size:13px;color:var(--muted);text-align:center}
    /* bottom spectrum */
    #spectrumWrap{position:fixed;left:0;right:0;bottom:0;height:160px;pointer-events:none;z-index:50;display:flex;align-items:flex-end;justify-content:center;padding:0 12px;box-sizing:border-box}
    .sbg{position:absolute;width:100%;height:100%;backdrop-filter:blur(18px);background:rgba(20,20,30,0.35);border-top:1px solid rgba(255,255,255,0.12);box-shadow:0 -10px 40px rgba(0,229,168,0.08);z-index:1}
    .sglow{position:absolute;bottom:0;left:50%;width:160%;height:140%;transform:translateX(-50%);background:radial-gradient(ellipse at bottom, rgba(0,255,255,0.25), rgba(255,0,255,0.08), transparent 70%);filter:blur(40px);z-index:0}
    .bar {height:6px;width:calc(100%/64 - 3px);margin:0 1.5px;border-radius:8px 8px 0 0;background:linear-gradient(to top,#00fff7,#a855f7);box-shadow:0 6px 18px rgba(124,92,255,0.06), inset 0 -6px 18px rgba(0,229,168,0.06);transition:height 0.08s linear;z-index:2;opacity:0.4}
    @media(max-width:1000px){.wrap{flex-direction:column;padding:12px}#left,#right{width:100%}#spectrumWrap{height:110px}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div id="left">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800">æ’­æ”¾æ¸…å–®</div>
          <div style="font-size:12px;color:var(--muted)">é»æ“Šæ’­æ”¾</div>
        </div>
        <div id="playlistArea"></div>
      </div>
      <div class="panel" style="display:flex;gap:8px;align-items:center;justify-content:center">
        <label class="file-btn">ï¼‹ æ–°å¢éŸ³æ¨‚
          <input id="fileAudio" type="file" accept="audio/*" multiple>
        </label>
        <button id="clearBtn" class="big-btn ghost">æ¸…é™¤å…¨éƒ¨</button>
      </div>
    </div>

    <!-- CENTER -->
    <div id="center" class="panel" style="border-radius:18px;display:flex;flex-direction:column;align-items:center;justify-content:center">
      <div id="title">å°šæœªæ’­æ”¾</div>
      <div id="time">00:00 / 00:00</div>
    </div>

    <!-- RIGHT -->
    <div id="right">
      <div class="panel">
        <div style="display:flex;flex-direction:column;gap:8px;width:100%;align-items:center">
          <div class="mode-indicator">æ’­æ”¾æ¨¡å¼</div>
          <button id="modeBtn" class="big-btn ghost">ALL â†º</button>
          <div style="display:flex;flex-direction:column;gap:10px;width:100%;margin-top:6px">
            <div style="display:flex;gap:10px;justify-content:center">
              <button id="prevBtn" class="big-btn">âŸ¸ ä¸Šä¸€é¦–</button>
              <button id="playBtn" class="big-btn">â–¶ / âšâš</button>
              <button id="nextBtn" class="big-btn">ä¸‹ä¸€é¦– âŸ¹</button>
            </div>
            <div style="display:flex;gap:10px;justify-content:center">
              <button id="delBtn" class="big-btn ghost">ğŸ—‘ åˆªé™¤ç›®å‰</button>
            </div>
          </div>
          <div style="width:100%;margin-top:8px">
            <div style="font-size:13px;color:var(--muted);margin-bottom:6px">éŸ³é‡</div>
            <input id="vol" class="slider" type="range" min="0" max="1" step="0.01" value="0.85">
          </div>
          <div style="width:100%;margin-top:8px">
            <div style="font-size:13px;color:var(--muted);margin-bottom:6px">é€²åº¦</div>
            <input id="progress" type="range" min="0" max="100" value="0" class="slider">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- spectrum -->
  <div id="spectrumWrap" aria-hidden="true">
    <div class="sbg"></div>
    <div class="sglow"></div>
    <!-- bars inserted by JS -->
  </div>

  <!-- single audio element -->
  <audio id="player" crossorigin="anonymous"></audio>

<script>
/* ========== å¯ç·¨è¼¯çš„é …ç›® ========== */
/* é€™è¡Œæ˜¯æ’­æ”¾æ¸¬è©¦æ­Œå‰çš„æç¬‘æ–‡å­— â€”â€” ä½ å¯ä»¥ç›´æ¥æŠŠå¼•è™Ÿè£¡çš„æ–‡å­—æ”¹æˆä½ è¦çš„æ–‡å­— */
const funnyText = 'çŒœçŒœçœ‹é€™æ˜¯ä»€éº¼æ­ŒğŸ¤£ğŸ¤£(é€™æ˜¯æ¸¬è©¦æ­Œæ›²ï¼‰éœ€è¦é»ä¸€ä¸‹ğŸ™‚';
/* æ¸¬è©¦æ­Œæ›²æª”åï¼ˆè«‹æŠŠä½ æƒ³æ¸¬è©¦çš„ mp3 æ”¾åœ¨åŒä¸€è³‡æ–™å¤¾ä¸¦å‘½åç‚º test.mp3ï¼‰ */
const TEST_FILE = 'test.mp3';
/* é–‹å ´ç­‰å¾…ç§’æ•¸ */
const INTRO_WAIT_SEC = 3;

/* ========== å…§éƒ¨è®Šæ•¸ ========== */
const fileAudio = document.getElementById('fileAudio');
const playlistArea = document.getElementById('playlistArea');
const titleEl = document.getElementById('title');
const timeEl = document.getElementById('time');
const modeBtn = document.getElementById('modeBtn');
const prevBtn = document.getElementById('prevBtn');
const playBtn = document.getElementById('playBtn');
const nextBtn = document.getElementById('nextBtn');
const delBtn = document.getElementById('delBtn');
const volSlider = document.getElementById('vol');
const progress = document.getElementById('progress');
const clearBtn = document.getElementById('clearBtn');
const spectrumWrap = document.getElementById('spectrumWrap');
const audio = document.getElementById('player');

let audioCtx = null, analyser = null, sourceNode = null, freqArray = null;
let tracks = []; // {name,url,duration}
let current = -1;
let raf = null;
let playing = false;
let mode = 'all'; // all | one | shuffle
const BAR_COUNT = 64;

/* create bar elements */
function makeBars(){
  spectrumWrap.querySelectorAll('.bar').forEach(n=>n.remove());
  for(let i=0;i<BAR_COUNT;i++){
    const b = document.createElement('div');
    b.className = 'bar';
    b.style.width = `calc(${100/BAR_COUNT}% - 3px)`;
    spectrumWrap.appendChild(b);
  }
}
makeBars();

/* audio context & analyser (create once) */
function ensureAudioCtx(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  sourceNode = audioCtx.createMediaElementSource(audio);
  sourceNode.connect(analyser);
  analyser.connect(audioCtx.destination);
  freqArray = new Uint8Array(analyser.frequencyBinCount);
}

/* track rendering */
function renderTracks(){
  playlistArea.innerHTML = '';
  tracks.forEach((t,i)=>{
    const div = document.createElement('div');
    div.className = 'track';
    div.innerHTML = `<div class="meta">${t.name}</div>
                     <div style="display:flex;align-items:center;gap:8px">
                       <div class="dur">${t.duration?formatTime(t.duration):'--:--'}</div>
                       <button class="small-btn" data-i="${i}">æ’­æ”¾</button>
                     </div>`;
    playlistArea.appendChild(div);
  });
  playlistArea.querySelectorAll('.small-btn').forEach(btn=>{
    btn.onclick = e => {
      const idx = parseInt(e.currentTarget.dataset.i,10);
      playIndex(idx);
    };
  });
}

/* add files */
fileAudio.addEventListener('change', e=>{
  const files = Array.from(e.target.files || []);
  addFiles(files);
  fileAudio.value = '';
});
function addFiles(files){
  files.forEach(f=>{
    const url = URL.createObjectURL(f);
    const rec = {name: f.name, url, duration: null};
    tracks.push(rec);
    const tmp = new Audio();
    tmp.src = url;
    tmp.addEventListener('loadedmetadata', ()=>{
      rec.duration = tmp.duration;
      renderTracks();
    }, {once:true});
  });
  renderTracks();
  if(current === -1 && tracks.length>0) playIndex(0);
}

/* play control */
function playIndex(i){
  if(i<0 || i>=tracks.length) return;
  current = i;
  const t = tracks[i];
  audio.src = t.url;
  titleEl.textContent = t.name;
  ensureAudioCtx();
  if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  audio.play().catch(()=>{});
  playing = true;
  startVisualizer();
}
function playNext(){
  if(tracks.length===0) return;
  if(mode === 'one'){ audio.currentTime = 0; audio.play(); return; }
  if(mode === 'shuffle'){
    if(tracks.length===1){ playIndex(0); return; }
    let next; do{ next = Math.floor(Math.random()*tracks.length);} while(next===current && tracks.length>1);
    playIndex(next); return;
  }
  const next = (current + 1) % tracks.length;
  playIndex(next);
}
function playPrev(){
  if(tracks.length===0) return;
  const prev = (current - 1 + tracks.length) % tracks.length;
  playIndex(prev);
}
playBtn.onclick = ()=> {
  if(!audio.src){ if(tracks.length) playIndex(0); return; }
  if(audio.paused){ audio.play(); playing=true; startVisualizer(); }
  else{ audio.pause(); playing=false; stopVisualizer(); }
};
prevBtn.onclick = playPrev;
nextBtn.onclick = playNext;

/* delete current -> stop and remove, do not auto-play next */
delBtn.onclick = ()=>{
  if(current < 0) return;
  audio.pause();
  audio.src = '';
  stopVisualizer();
  tracks.splice(current,1);
  renderTracks();
  current = -1;
  titleEl.textContent = 'å°šæœªæ’­æ”¾';
  timeEl.textContent = '00:00 / 00:00';
};

/* clear all */
clearBtn.onclick = ()=>{
  audio.pause(); audio.src=''; stopVisualizer();
  tracks=[]; current=-1; titleEl.textContent='å°šæœªæ’­æ”¾'; timeEl.textContent='00:00 / 00:00';
  renderTracks();
};

/* mode toggle */
modeBtn.onclick = ()=>{
  if(mode==='all'){ mode='one'; modeBtn.textContent='ONE â†»'; }
  else if(mode==='one'){ mode='shuffle'; modeBtn.textContent='SHUFFLE â‡„'; }
  else{ mode='all'; modeBtn.textContent='ALL â†º'; }
};

/* progress & volume */
audio.addEventListener('timeupdate', ()=>{
  if(!isFinite(audio.duration)) return;
  timeEl.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
  progress.value = (audio.currentTime / audio.duration) * 100;
});
progress.addEventListener('input', e=>{ if(audio.duration) audio.currentTime = e.target.value/100 * audio.duration; });
volSlider.addEventListener('input', e=>{ audio.volume = parseFloat(e.target.value); });

/* ended behavior */
audio.addEventListener('ended', ()=>{
  // if the ended track is the test file playing on intro, we should not auto-play next test; normal behavior:
  if(playing && current>=0){
    // normal playlist ended: go next (mode applies)
    playNext();
  } else {
    // nothing
  }
});

/* visualizer */
function startVisualizer(){
  ensureAudioCtx();
  if(!analyser) return;
  analyser.smoothingTimeConstant = 0.6;
  freqArray = new Uint8Array(analyser.frequencyBinCount);
  if(raf) cancelAnimationFrame(raf);
  raf = requestAnimationFrame(drawBars);
}
function stopVisualizer(){
  if(raf) cancelAnimationFrame(raf);
  raf = null;
  // reduce bars to small height
  document.querySelectorAll('.bar').forEach(b=>{ b.style.height = '6px'; b.style.opacity = '0.25'; });
}
function drawBars(){
  if(!analyser) return;
  analyser.getByteFrequencyData(freqArray);
  const bars = document.querySelectorAll('.bar');
  const step = Math.floor(freqArray.length / bars.length);
  for(let i=0;i<bars.length;i++){
    const v = freqArray[i*step];
    const maxH = 120;
    const h = Math.max(6, Math.round((v/255) * maxH));
    bars[i].style.height = h + 'px';
    bars[i].style.opacity = Math.max(0.35, v/255);
  }
  raf = requestAnimationFrame(drawBars);
}

/* drag & drop */
document.addEventListener('dragover', e=>e.preventDefault());
document.addEventListener('drop', e=>{
  e.preventDefault();
  const files = Array.from(e.dataTransfer.files || []);
  const aud = files.filter(f=>f.type && f.type.startsWith('audio'));
  if(aud.length) addFiles(aud);
});

/* helpers */
function formatTime(s){ if(!isFinite(s)) return '00:00'; const m=Math.floor(s/60).toString().padStart(2,'0'); const sec=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }

/* ========== Intro: show funny text then play local test file (once) ========== */
function showIntroThenTest(){
  // overlay-like status message in center
  const prevTitle = titleEl.textContent;
  titleEl.textContent = 'ğŸ¤ ä½ çµ•å°çŒœä¸åˆ°é€™é¦–æ­Œæ˜¯ä»€éº¼...';
  // show your custom funny text if set
  if(funnyText && funnyText.trim().length) titleEl.textContent += ' ' + funnyText;
  // wait then try to play test file
  setTimeout(async ()=>{
    try{
      // attempt to load TEST_FILE from same folder
      audio.src = TEST_FILE;
      ensureAudioCtx();
      if(audioCtx.state === 'suspended') await audioCtx.resume();
      // play once (no loop). We'll use playing flag false so ended handler won't auto-next
      await audio.play();
      // visualizer while test plays
      startVisualizer();
      // after end: stop visualizer and clear src; restore UI (not auto play playlist)
      audio.addEventListener('ended', function onTestEnd(){
        stopVisualizer();
        audio.removeEventListener('ended', onTestEnd);
        audio.src = '';
        titleEl.textContent = prevTitle || 'å°šæœªæ’­æ”¾';
        timeEl.textContent = '00:00 / 00:00';
        // after test ends, we DON'T auto-start playlist; user can press play or choose a track
      }, {once:true});
    }catch(err){
      // couldn't load/play test file (missing or blocked) â€” just restore UI silently
      console.warn('æ¸¬è©¦æ­Œæ›²ç„¡æ³•æ’­æ”¾æˆ–ä¸å­˜åœ¨ï¼š', err);
      titleEl.textContent = prevTitle || 'å°šæœªæ’­æ”¾';
    }
  }, INTRO_WAIT_SEC * 1000);
}

/* ====== init ====== */
(function init(){
  // create bars
  makeBars();
  // default volume
  audio.volume = parseFloat(volSlider.value || 0.85);
  // start intro (attempt to play test.mp3 in same folder)
  // Note: Chrome/Firefox may block autoplay until user interacts; in that case user click anywhere will resume.
  showIntroThenTest();
  // ensure click resumes audio context per autoplay policies
  document.addEventListener('click', function once(){
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    document.removeEventListener('click', once);
  });
})();
</script>
</body>
</html>
